{"version":3,"file":"storage.js","sourceRoot":"","sources":["../../src/storage.ts"],"names":[],"mappings":"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","sourcesContent":["import { _extend, logger } from './utils'\nimport { PersistentStore, Properties } from './types'\nimport Config from './config'\n\nconst DOMAIN_MATCH_REGEX = /[a-z0-9][a-z0-9-]+\\.[a-z.]{2,6}$/i\n\n// Methods partially borrowed from quirksmode.org/js/cookies.html\nexport const cookieStore: PersistentStore = {\n    is_supported: () => true,\n\n    error: function (msg) {\n        logger.error('cookieStore error: ' + msg)\n    },\n\n    get: function (name) {\n        try {\n            const nameEQ = name + '='\n            const ca = document.cookie.split(';')\n            for (let i = 0; i < ca.length; i++) {\n                let c = ca[i]\n                while (c.charAt(0) == ' ') {\n                    c = c.substring(1, c.length)\n                }\n                if (c.indexOf(nameEQ) === 0) {\n                    return decodeURIComponent(c.substring(nameEQ.length, c.length))\n                }\n            }\n        } catch (err) {}\n        return null\n    },\n\n    parse: function (name) {\n        let cookie\n        try {\n            cookie = JSON.parse(cookieStore.get(name)) || {}\n        } catch (err) {\n            // noop\n        }\n        return cookie\n    },\n\n    set: function (name, value, days, cross_subdomain, is_secure) {\n        try {\n            let cdomain = '',\n                expires = '',\n                secure = ''\n\n            if (cross_subdomain) {\n                const matches = document.location.hostname.match(DOMAIN_MATCH_REGEX),\n                    domain = matches ? matches[0] : ''\n\n                cdomain = domain ? '; domain=.' + domain : ''\n            }\n\n            if (days) {\n                const date = new Date()\n                date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000)\n                expires = '; expires=' + date.toUTCString()\n            }\n\n            if (is_secure) {\n                secure = '; secure'\n            }\n\n            const new_cookie_val =\n                name +\n                '=' +\n                encodeURIComponent(JSON.stringify(value)) +\n                expires +\n                '; SameSite=Lax; path=/' +\n                cdomain +\n                secure\n            document.cookie = new_cookie_val\n            return new_cookie_val\n        } catch (err) {\n            return\n        }\n    },\n\n    remove: function (name, cross_subdomain) {\n        try {\n            cookieStore.set(name, '', -1, cross_subdomain)\n        } catch (err) {\n            return\n        }\n    },\n}\n\nlet _localStorage_supported: boolean | null = null\n\nexport const localStore: PersistentStore = {\n    is_supported: function () {\n        if (_localStorage_supported !== null) {\n            return _localStorage_supported\n        }\n\n        let supported = true\n        if (typeof window !== 'undefined') {\n            try {\n                const key = '__mplssupport__',\n                    val = 'xyz'\n                localStore.set(key, val)\n                if (localStore.get(key) !== '\"xyz\"') {\n                    supported = false\n                }\n                localStore.remove(key)\n            } catch (err) {\n                supported = false\n            }\n        } else {\n            supported = false\n        }\n        if (!supported) {\n            logger.error('localStorage unsupported; falling back to cookie store')\n        }\n\n        _localStorage_supported = supported\n        return supported\n    },\n\n    error: function (msg) {\n        logger.error('localStorage error: ' + msg)\n    },\n\n    get: function (name) {\n        try {\n            return window.localStorage.getItem(name)\n        } catch (err) {\n            localStore.error(err)\n        }\n        return null\n    },\n\n    parse: function (name) {\n        try {\n            return JSON.parse(localStore.get(name)) || {}\n        } catch (err) {\n            // noop\n        }\n        return null\n    },\n\n    set: function (name, value) {\n        try {\n            window.localStorage.setItem(name, JSON.stringify(value))\n        } catch (err) {\n            localStore.error(err)\n        }\n    },\n\n    remove: function (name) {\n        try {\n            window.localStorage.removeItem(name)\n        } catch (err) {\n            localStore.error(err)\n        }\n    },\n}\n\n// Use localstorage for most data but still use cookie for distinct_id\n// This solves issues with cookies having too much data in them causing headers too large\n// Also makes sure we don't have to send a ton of data to the server\nexport const localPlusCookieStore: PersistentStore = {\n    ...localStore,\n    parse: function (name) {\n        try {\n            let extend: Properties = {}\n            try {\n                // See if there's a cookie stored with data.\n                extend = cookieStore.parse(name) || {}\n                if (extend['distinct_id']) {\n                    cookieStore.set(name, { distinct_id: extend['distinct_id'] })\n                }\n            } catch (err) {}\n            const value = _extend(extend, JSON.parse(localStore.get(name) || '{}'))\n            localStore.set(name, value)\n            return value\n        } catch (err) {\n            // noop\n        }\n        return null\n    },\n\n    set: function (name, value, days, cross_subdomain, is_secure) {\n        try {\n            localStore.set(name, value)\n            if (value.distinct_id) {\n                cookieStore.set(name, { distinct_id: value.distinct_id }, days, cross_subdomain, is_secure)\n            }\n        } catch (err) {\n            localStore.error(err)\n        }\n    },\n\n    remove: function (name, cross_subdomain) {\n        try {\n            window.localStorage.removeItem(name)\n            cookieStore.remove(name, cross_subdomain)\n        } catch (err) {\n            localStore.error(err)\n        }\n    },\n}\n\nconst memoryStorage: Properties = {}\n\n// Storage that only lasts the length of the pageview if we don't want to use cookies\nexport const memoryStore: PersistentStore = {\n    is_supported: function () {\n        return true\n    },\n\n    error: function (msg) {\n        logger.error('memoryStorage error: ' + msg)\n    },\n\n    get: function (name) {\n        return memoryStorage[name] || null\n    },\n\n    parse: function (name) {\n        return memoryStorage[name] || null\n    },\n\n    set: function (name, value) {\n        memoryStorage[name] = value\n    },\n\n    remove: function (name) {\n        delete memoryStorage[name]\n    },\n}\n\nlet sessionStorageSupported: boolean | null = null\nexport const resetSessionStorageSupported = () => {\n    sessionStorageSupported = null\n}\n// Storage that only lasts the length of a tab/window. Survives page refreshes\nexport const sessionStore: PersistentStore = {\n    is_supported: function () {\n        if (sessionStorageSupported !== null) {\n            return sessionStorageSupported\n        }\n        sessionStorageSupported = true\n        if (typeof window !== 'undefined') {\n            try {\n                const key = '__support__',\n                    val = 'xyz'\n                sessionStore.set(key, val)\n                if (sessionStore.get(key) !== '\"xyz\"') {\n                    sessionStorageSupported = false\n                }\n                sessionStore.remove(key)\n            } catch (err) {\n                sessionStorageSupported = false\n            }\n        } else {\n            sessionStorageSupported = false\n        }\n        return sessionStorageSupported\n    },\n\n    error: function (msg) {\n        if (Config.DEBUG) {\n            logger.error('sessionStorage error: ', msg)\n        }\n    },\n\n    get: function (name) {\n        try {\n            return window.sessionStorage.getItem(name)\n        } catch (err) {\n            sessionStore.error(err)\n        }\n        return null\n    },\n\n    parse: function (name) {\n        try {\n            return JSON.parse(sessionStore.get(name)) || null\n        } catch (err) {\n            // noop\n        }\n        return null\n    },\n\n    set: function (name, value) {\n        try {\n            window.sessionStorage.setItem(name, JSON.stringify(value))\n        } catch (err) {\n            sessionStore.error(err)\n        }\n    },\n\n    remove: function (name) {\n        try {\n            window.sessionStorage.removeItem(name)\n        } catch (err) {\n            sessionStore.error(err)\n        }\n    },\n}\n"]}